<!DOCTYPE html>
<html><head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta content="no-cache,must-revalidate" http-equiv="Cache-Control">
    <meta content="no-cache" http-equiv="pragma">
    <meta content="0" http-equiv="expires">
    <meta content="telephone=no, address=no" name="format-detection">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
    <meta content="no" name="apple-mobile-web-app-capable">
    <meta content="false" id="twcClient" name="twcClient">
    <title>故事</title>
    <link rel="stylesheet" type="text/css" href="%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE%E7%89%B9%E6%95%88_files/story-chapter.css">
</head>
<body>
<div class="page j-page">
    <!--内容 -->
    <div id="container" class="p-album-detail">
        <article class="mod album-top">
            <div class="cl">
                <div class="pic album-face shadow">
                    <img itemprop="image" src="%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE%E7%89%B9%E6%95%88_files/1516154716077_1.jpg" alt="">
                </div>
                <div class="info mgl-140">
                    <input id="storyId" value="1" type="hidden">
                    <h2 class="album-tit elli-multi">凯叔西游记第一部</h2>
                    <p class="elli playCount"><span>播放：</span>76次</p>
                </div>
            </div>
        </article>
        <div>
            <div class="j-view">
                <!--章节 -->
                <div class="sound-list" data-view="soundlist">
                    <ol class="mod list-t1 j-list">
                        <li class="item-block trackItem">
                                <a class="col info" href="javascript:void(0);">
                                    <i class="ic fl"></i>
                                    <h4 class="item-tit elli-s">01石猴出世</h4>
                                </a>
                                <a id="1" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, '%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE%E7%89%B9%E6%95%88_files/1516155083258_1 01石猴出世.mp3')">
                                    <i class="iconfont icon-play2"></i>
                                </a>
                            </li>
                        <li class="item-block trackItem">
                                <a class="col info" href="javascript:void(0);">
                                    <i class="ic fl"></i>
                                    <h4 class="item-tit elli-s">02悟空学艺</h4>
                                </a>
                                <a id="2" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155217862_1 02悟空学艺.mp3')">
                                    <i class="iconfont icon-play2"></i>
                                </a>
                            </li>
                        <li class="item-block trackItem">
                                <a class="col info" href="javascript:void(0);">
                                    <i class="ic fl"></i>
                                    <h4 class="item-tit elli-s">03金箍棒</h4>
                                </a>
                                <a id="3" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155200397_1 03金箍棒.mp3')">
                                    <i class="iconfont icon-play2"></i>
                                </a>
                            </li>
                        <li class="item-block trackItem">
                                <a class="col info" href="javascript:void(0);">
                                    <i class="ic fl"></i>
                                    <h4 class="item-tit elli-s">04大闹幽冥界</h4>
                                </a>
                                <a id="4" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155260797_1 04大闹幽冥界.mp3')">
                                    <i class="iconfont icon-play2"></i>
                                </a>
                            </li>
                        <li class="item-block trackItem">
                                <a class="col info" href="javascript:void(0);">
                                    <i class="ic fl"></i>
                                    <h4 class="item-tit elli-s">05官封弼马温</h4>
                                </a>
                                <a id="5" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155307795_1 05官封弼马温.mp3')">
                                    <i class="iconfont icon-play2"></i>
                                </a>
                            </li>
                        <li class="item-block trackItem">
                                <a class="col info" href="javascript:void(0);">
                                    <i class="ic fl"></i>
                                    <h4 class="item-tit elli-s">06掌管蟠桃园</h4>
                                </a>
                                <a id="6" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155337191_1 06掌管蟠桃园.mp3')">
                                    <i class="iconfont icon-play2"></i>
                                </a>
                            </li>
                        <li class="item-block trackItem">
                                <a class="col info" href="javascript:void(0);">
                                    <i class="ic fl"></i>
                                    <h4 class="item-tit elli-s">07醉下瑶池</h4>
                                </a>
                                <a id="7" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155413840_1 07醉下瑶池.mp3')">
                                    <i class="iconfont icon-play2"></i>
                                </a>
                            </li>
                        <li class="item-block trackItem">
                                <a class="col info" href="javascript:void(0);">
                                    <i class="ic fl"></i>
                                    <h4 class="item-tit elli-s">08大战二郎神</h4>
                                </a>
                                <a id="8" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155426145_1 08大战二郎神.mp3')">
                                    <i class="iconfont icon-play2"></i>
                                </a>
                            </li>
                        <li class="item-block trackItem">
                                <a class="col info" href="javascript:void(0);">
                                    <i class="ic fl"></i>
                                    <h4 class="item-tit elli-s">09火眼金睛</h4>
                                </a>
                                <a id="9" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155447667_1 09火眼金睛.mp3')">
                                    <i class="iconfont icon-play2"></i>
                                </a>
                            </li>
                        <li class="item-block trackItem">
                                <a class="col info" href="javascript:void(0);">
                                    <i class="ic fl"></i>
                                    <h4 class="item-tit elli-s">10五行山下</h4>
                                </a>
                                <a id="10" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155463185_1 10五行山下.mp3')">
                                    <i class="iconfont icon-play2"></i>
                                </a>
                            </li>
                        <li class="item-block trackItem"><a class="col info" href="javascript:void(0);"><i class="ic fl"></i><h4 class="item-tit elli-s">11大圣拜师</h4></a><a id="11" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155554996_1 11大圣拜师.mp3')"><i class="iconfont icon-play2"></i></a></li><li class="item-block trackItem"><a class="col info" href="javascript:void(0);"><i class="ic fl"></i><h4 class="item-tit elli-s">12紧箍咒</h4></a><a id="12" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155583424_1 12紧箍咒.mp3')"><i class="iconfont icon-play2"></i></a></li><li class="item-block trackItem"><a class="col info" href="javascript:void(0);"><i class="ic fl"></i><h4 class="item-tit elli-s">13马换小白龙</h4></a><a id="13" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155567542_1 13马换小白龙.mp3')"><i class="iconfont icon-play2"></i></a></li><li class="item-block trackItem"><a class="col info" href="javascript:void(0);"><i class="ic fl"></i><h4 class="item-tit elli-s">14火烧观音院</h4></a><a id="14" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155617635_1 14火烧观音院.mp3')"><i class="iconfont icon-play2"></i></a></li><li class="item-block trackItem"><a class="col info" href="javascript:void(0);"><i class="ic fl"></i><h4 class="item-tit elli-s">15计捉黑熊怪(上)</h4></a><a id="15" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155619486_1 15计捉黑熊怪(上).mp3')"><i class="iconfont icon-play2"></i></a></li><li class="item-block trackItem"><a class="col info" href="javascript:void(0);"><i class="ic fl"></i><h4 class="item-tit elli-s">16计捉黑熊怪(下)</h4></a><a id="16" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155684193_1 16计捉黑熊怪(下).mp3')"><i class="iconfont icon-play2"></i></a></li><li class="item-block trackItem"><a class="col info" href="javascript:void(0);"><i class="ic fl"></i><h4 class="item-tit elli-s">17猪八戒拜师(上)</h4></a><a id="17" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155737470_1 17猪八戒拜师(上).mp3')"><i class="iconfont icon-play2"></i></a></li><li class="item-block trackItem"><a class="col info" href="javascript:void(0);"><i class="ic fl"></i><h4 class="item-tit elli-s">18猪八戒拜师(下)</h4></a><a id="18" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155719451_1 18猪八戒拜师(下).mp3')"><i class="iconfont icon-play2"></i></a></li><li class="item-block trackItem"><a class="col info" href="javascript:void(0);"><i class="ic fl"></i><h4 class="item-tit elli-s">19大战黄风怪(上)</h4></a><a id="19" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155751044_1 19 大战黄风怪(上).mp3')"><i class="iconfont icon-play2"></i></a></li><li class="item-block trackItem"><a class="col info" href="javascript:void(0);"><i class="ic fl"></i><h4 class="item-tit elli-s">20大战黄风怪(下)</h4></a><a id="20" class="col col-r j-ibtn btn-player" onclick="togglePaly(this, 'http://192.168.1.57:8082/supplyfile/storyChapter/1516155841924_1 20大战黄风怪(下).mp3')"><i class="iconfont icon-play2"></i></a></li></ol>
                    <!-- 获取更多按钮 -->
                    <a class="text-more c01" href="javascript:void(0);" onclick="getMore()">
                        <i class="icon icon-loading hidden"></i>获取更多...
                    </a>
                    <!-- 获取更多按钮 -->
                </div>
                <!--章节 -->
            </div>
        </div>
    </div>
    <!-- 内容 -->
</div>
<script type="text/javascript" src="%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE%E7%89%B9%E6%95%88_files/jquery-3.js"></script>
<script type="text/javascript" src="%E9%9F%B3%E9%A2%91%E6%92%AD%E6%94%BE%E7%89%B9%E6%95%88_files/alertConfirm.js"></script>
<script type="text/javascript">
    // 总页数
    var totalPage = 3;
    // 当前页数
    var page = 1;
    // 分页大小
    var pageSize = 10;
    var weburl = "http://192.168.1.57:8082/supplyfile/";
    var storyId = $("#storyId").val();

    $(window).scroll(function () {
        var scrollTop = $(this).scrollTop();
        var windowHeight = $(this).height();
        var scrollHeight = $(document).height();
        if (scrollTop + windowHeight >= scrollHeight - 36) {
            getMore();
        }
    });

    function getMore() {
        if (page < totalPage) {
            $(".icon-loading").removeClass("hidden");
            page++;
            $.ajax({
                type: "get",
                url: "http://localhost:8082/appInterface/story/chapter/page",
                data: {
                    storyId: storyId,
                    page: page,
                    pageSize: pageSize
                },
                async: false,
                success: function (data) {
                    var chapterHtml = "";
                    var jsonData = JSON.parse(data);
                    $.each(jsonData, function (i, chapter) {
                        chapterHtml += "<li class=\"item-block trackItem\">"
                            + "<a class=\"col info\" href=\"javascript:void(0);\">"
                            + "<i class=\"ic fl\"></i>"
                            + "<h4 class=\"item-tit elli-s\">" + chapter.name + "</h4>"
                            + "</a>"
                            + "<a id=\"" + chapter.id + "\" class=\"col col-r j-ibtn btn-player\" onclick=\"togglePaly(this, '" + weburl + chapter.fileTamber + "')\">"
                            + "<i class=\"iconfont icon-play2\"></i>"
                            + "</a>"
                            + "</li>";
                    });
                    $(".list-t1").append(chapterHtml);
                    $(".icon-loading").addClass("hidden");
                    hideTextMore();
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    zdalert("提示:", "系统繁忙！");
                    return;
                }
            });
        } else {
            hideTextMore();
        }
    }

    function hideTextMore() {
        if (page >= totalPage) {
            $(".text-more").hide();
        }
    }

    var audio = document.createElement("audio");
    var canvas;
    function togglePaly(obj, audioPath) {
        if ($(obj).hasClass("is-playing")) {
            audio.pause();
            $(obj).removeClass("is-playing");
            $(obj).prev().find(".ic").removeClass("ic-playing").addClass("ic-pausing");
            $(obj).find("canvas").hide();
            $(obj).find("i").show();
        } else {
            if ($(obj).find("canvas").length > 0) {
                audio.play();
                $(obj).find("i").hide();
                $(obj).addClass("is-playing");
                $(obj).prev().find(".ic").removeClass("ic-pausing").addClass("ic-playing");
                $(obj).find("canvas").show();
            } else {
                audio.src = audioPath;
                audio.play();
                $(".btn-player").removeClass("is-playing");
                $(".btn-player").find("canvas").remove();
                $(".btn-player").find("i").show();
                $(".ic").removeClass("ic-playing").removeClass("ic-pausing");
                $(obj).find("i").hide();
                $(obj).addClass("is-playing");
                $(obj).prev().find(".ic").addClass("ic-playing");
                canvas = document.createElement("canvas");
                drawCircle(canvas, 0);
                $(obj).append(canvas);
                updatePlayNum($(obj).attr("id"));
            }
        }
    }

    // 更新播放数
    function updatePlayNum(id) {
        $.get("http://localhost:8082/appInterface/story/chapter/playNum", {id: id});
    }

    //绑定timeupdate事件
    audio.addEventListener("timeupdate", function () {
        if (!isNaN(audio.duration)) {
            var progressValue = audio.currentTime / audio.duration; //用时间比来获取进度条的值
            if (progressValue == 1) {
                progressValue = 0;//当播放完成，进度条跳到开始
            }
            drawCircle(canvas, progressValue);
        }
    }, false);

    //绑定ended事件
    audio.addEventListener("ended", function () {
        var _li = $(".btn-player").find("canvas").parent().parent().next();
        if (_li.length > 0) {
            $(".btn-player").find("canvas").parent().parent().next().find("a").each(function () {
                if (typeof($(this).attr("onclick")) != "undefined") {
                    var str = $(this).attr("onclick");
                    togglePaly(this, str.substring(str.indexOf("'") + 1, str.lastIndexOf("'")));
                }
            });
        } else {
            $(".btn-player").removeClass("is-playing");
            $(".btn-player").find("canvas").remove();
            $(".btn-player").find("i").show();
            $(".ic").removeClass("ic-playing").removeClass("ic-pausing");
        }
    }, false);

    drawCircle = function (canvas, percentage) {
        var canvasWidth = 24;
        var innerR = 11;//半径
        var ctx;
        canvas.setAttribute("width", canvasWidth + "px");
        canvas.setAttribute("height", canvasWidth + "px");
        if (canvas.getContext) {
            ctx = canvas.getContext("2d");
        }
        ctx.translate(canvasWidth / 2, canvasWidth / 2);
        ctx.beginPath();
        ctx.lineWidth = 1;
        ctx.strokeStyle = "red";
        ctx.moveTo(-3, 5);
        ctx.lineTo(-3, -5);
        ctx.stroke();  // 进行绘制

        ctx.beginPath();
        ctx.strokeStyle = "red";
        ctx.moveTo(3, 5);
        ctx.lineTo(3, -5);
        ctx.stroke();  // 进行绘制

        ctx.beginPath();
        ctx.arc(0, 0, innerR, 0, Math.PI * 2, false);
        ctx.lineWidth = 1;
        ctx.strokeStyle = "#999999";
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(0, 0, innerR, Math.PI * 1.5, (Math.PI * 1.5 + Math.PI * 2 / 180 + percentage * Math.PI * 2), false);
        ctx.lineWidth = 1;
        ctx.strokeStyle = "red";
        ctx.stroke();
    };

    window.onbeforeunload = function (event) {
        audio.pause();
        audio.src = "";
    }
</script>


</body></html>
